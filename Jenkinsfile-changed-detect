pipeline {
    agent any

    environment {
        REGISTRY = "ghcr.io/conicuznhm"
        IMAGE_API = "form-api"
        IMAGE_VITE = "form-vite"
        TAG = "2"
        CONTAINER_CREDENTIALS_ID = "ghcr"
    }

    triggers {
        githubPush()
    }

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/conicuznhm/form-app.git', branch: 'main'
            }
        }

        stage('Detect Changed Images') {
            steps {
                script {
                    def changedFiles = sh(script: "git diff --name-only origin/main", returnStdout: true).trim().split('\n')

                    env.BUILD_API = changedFiles.any {it.startsWith('fill-api/')} ? "true" : "false"
                    env.BUILD_VITE = changedFiles.any {it.startsWith('fill-vite/')} ? "true" : "false"
                }
            }
        }

        stage('Build Changed Images') {
            steps {
                script {
                    if (env.BUILD_API?.toBoolean()) {
                        echo "Building form-api image..."
                        sh "docker build -t $REGISTRY/$IMAGE_API:$TAG ./fill-api"
                    }

                    if (env.BUILD_VITE?.toBoolean()) {
                        echo "Building form-vite image..."
                        sh "docker build -t $REGISTRY/$IMAGE_VITE:$TAG ./fill-vite"
                    }
                }
            }
        }

        stage('Login to GHCR') {
            steps {
                withCredentials([usernamePassword(credentialsId: "${CONTAINER_CREDENTIALS_ID}", usernameVariable: 'USERNAME', passwordVariable: 'TOKEN')]) {
                    sh "echo $TOKEN | docker login ghcr.io -u $USERNAME --password-stdin"
                }
            }
        }

        stage('Push Images to GHCR') {
            steps {
                script {
                    if (env.BUILD_API?.toBoolean()) {
                        echo "Pushing $REGISTRY/$IMAGE_API:$TAG image..."
                        sh "docker push $REGISTRY/$IMAGE_API:$TAG"
                    }

                    if (env.BUILD_VITE?.toBoolean()) {
                        echo "Pushing $REGISTRY/$IMAGE_VITE:$TAG image..."
                        sh "docker push $REGISTRY/$IMAGE_VITE:$TAG"
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Cleaning up credentials...'
            sh 'docker logout ghcr.io'
        }
    }
}